<?php

/**
 * Implements hook_menu().
 */
function workbench_moderation_extras_menu() {
  $items = array();

  // Module settings
  $items["admin/config/workbench/moderation_extras"] = array(
    'title' => 'Workbench Moderation Extras',
    'description' => 'Allows to set users to receive email notifications for certain transition states',
    'page callback' => 'drupal_get_form',
    'page arguments' => array(
      'workbench_moderation_extras_admin_settings',
    ),
    'access arguments' => array(
      'administer workbench moderation',
    ),
    'file' => 'workbench_moderation_extras.admin.inc',
  );

  return $items;
}

// let's try hook_cron to change states...

/**
 * Implements hook_cron().
 */
function workbench_moderation_extras_cron() {
  // get all published nodes that have been updated more then needed seconds ago
  $nids = _workbench_moderation_extras_get_published_state_nodes();

  // Change their state
  // So, a state is tied by a vid (revision id)
  // That means we need a new revision copy?
  if (!empty($nids)) {
    foreach ($nids as $nid) {
      $node = node_load($nid);
      $node->revision = 1;
      $node->log = t('This node needs a Regular review');
      node_save($node);
      workbench_moderation_moderate($node, 'regular_review');
      unset($node);
    }
  }

  // Notify all needed users about it
}

function _workbench_moderation_extras_get_published_state_nodes() {
  $node_types = variable_get('workbench_moderation_extras_node_types');
  $nodes = db_select('workbench_moderation_node_history', 'wmnh');
  $nodes->fields('wmnh', array('nid'));
  $nodes->join('node', 'node', '(wmnh.nid=node.nid)');
  $nodes->condition('wmnh.from_state', 'regular_review', '!='); // we don't want to change back on this.
//  $nodes->condition('wmnh.state', 'published', '='); // from_state != regular_review to state publish should be all covered cases.
  $nodes->condition('wmnh.published', 1, '=');
  if (is_array($node_types) AND !empty($node_types)) {
    $nodes_or = db_or();
    foreach ($node_types as $type) {
      $nodes_or->condition('node.type', $type);
    }
    $nodes->condition($nodes_or);
  }
  $nodes->condition('wmnh.stamp', time() - variable_get('workbench_moderation_extras_time', 3600 * 24 * 7), '<'); // only if lower then expiration time
  $nodes = $nodes->execute();
  $nids = array();
  foreach ($nodes as $node) {
    $nids[] = $node->nid;
  }
  return $nids;
}

/**
 * Implements hook_init().
 */
function workbench_moderation_extras_init() {
//  dsm(workbench_moderation_states());
}